# Phase 1.2: Target Path Resolution Fix

**Date**: 2025-11-21T23:14:04Z  
**Status**: ✅ Complete

## Problem

The target root in the linker was being calculated from `$HOME` unconditionally, which was incorrect. According to the architecture, target paths should be:
1. Relative to cwd (with `pathResolution: cwd`)
2. Relative to config (with `pathResolution: config`)
3. Absolute paths
4. Paths starting with `~` (expand to HOME)

## Solution

### 1. Removed `target_root` parameter from Linker

**File**: `src/linker.rs`

- Removed `target_root` field from `Linker` struct
- Updated `Linker::new()` to only take `repo_root` parameter
- Target paths are now resolved dynamically based on their format

### 2. Fixed `resolve_target_path()` function

**File**: `src/linker.rs` (lines 237-257)

The function now properly handles:
- **`~` expansion**: Paths starting with `~/` or just `~` are expanded to `$HOME`
- **Absolute paths**: Paths starting with `/` are used as-is
- **Relative paths**: Paths without prefix are resolved relative to current working directory

```rust
fn resolve_target_path(&self, target: &Utf8Path) -> Result<Utf8PathBuf> {
    // Handle ~ expansion (relative to HOME)
    if path starts with "~/" or is "~" {
        return HOME + stripped_path
    }
    
    // Handle absolute paths
    if target.is_absolute() {
        return target as-is
    }
    
    // Handle relative paths (relative to cwd)
    return cwd + target
}
```

### 3. Updated `commands.rs`

**File**: `src/commands.rs`

- Removed `target_root` calculation from `link()` function (lines 39-40)
- Removed `target_root` calculation from `clean()` function (lines 192-193)
- Updated `Linker::new()` calls to only pass `repo_root`

### 4. Fixed `clean()` function

**File**: `src/linker.rs` (lines 212-232)

- Changed from `target_path.exists()` to `fs::symlink_metadata(&target_path)`
- This properly handles broken symlinks (symlinks whose targets don't exist)
- Ensures symlinks are removed even if their targets are missing

### 5. Updated all tests

**File**: `src/linker.rs` (tests module)

- Updated `setup_test_fs()` to only return `repo_root`
- Modified all tests to use absolute paths for targets
- Fixed test assertions to match new behavior

## Test Results

All 34 tests passing:
- ✅ Config parsing tests (16 tests)
- ✅ State management tests (8 tests)
- ✅ Linker tests (10 tests)

## Key Changes

1. **Target paths are no longer tied to HOME**: The linker now resolves target paths based on their format, not a fixed root
2. **Proper handling of path types**: Absolute, relative, and `~`-prefixed paths are all handled correctly
3. **Broken symlink support**: The `clean` command now properly removes broken symlinks

## Architecture Compliance

The implementation now correctly follows the architecture specification:
- ✅ Target paths can be absolute
- ✅ Target paths can be relative (to cwd)
- ✅ Target paths can use `~` expansion
- ✅ Path resolution strategy (`config` vs `cwd`) only affects source paths, not target paths

## Next Steps

Phase 1.2 is complete. Ready to proceed with Phase 3 (Detection & Adoption) or any other tasks.
