# Phase 1.2: Target Path Resolution Fix (v2 - Corrected)

**Date**: 2025-11-21T23:30:00Z  
**Status**: ✅ Complete

## Problem

The initial fix for Phase 1.2 was incomplete. The `resolve_target_path()` function was resolving relative target paths relative to the current working directory, but it should respect the `pathResolution` strategy:

- **`pathResolution: config`**: Relative paths should be resolved relative to the config file's directory (config_dir_or_cwd)
- **`pathResolution: cwd`**: Relative paths should be resolved relative to the current working directory

## Solution

### 1. Added `path_resolution` field to Linker

**File**: `src/linker.rs`

```rust
pub struct Linker {
    /// Root directory of the dotfiles repository (or cwd, depending on path_resolution)
    config_dir_or_cwd: Utf8PathBuf,
    /// Path resolution strategy
    path_resolution: PathResolution,
}
```

- Updated `Linker::new()` to accept `path_resolution` parameter
- The linker now knows which strategy to use for resolving paths

### 2. Fixed `resolve_target_path()` to respect `pathResolution`

**File**: `src/linker.rs` (lines 257-293)

```rust
fn resolve_target_path(&self, target: &Utf8Path) -> Result<Utf8PathBuf> {
    // Handle ~ expansion (relative to HOME)
    if path starts with "~/" or is "~" {
        return HOME + stripped_path
    }
    
    // Handle absolute paths
    if target.is_absolute() {
        return target as-is
    }
    
    // Handle relative paths based on path resolution strategy
    match self.path_resolution {
        PathResolution::Config => {
            // Resolve relative to config_dir_or_cwd (config file's directory)
            config_dir_or_cwd + target
        }
        PathResolution::Cwd => {
            // Resolve relative to current working directory
            cwd + target
        }
    }
}
```

### 3. Updated `commands.rs`

**File**: `src/commands.rs`

- Updated `link()` function to pass `config.path_resolution` to `Linker::new()`
- Updated `clean()` function to pass `config.path_resolution` to `Linker::new()`

### 4. Updated all tests

**File**: `src/linker.rs` (tests module)

- Updated all `Linker::new()` calls to pass `PathResolution::Config`
- Updated `setup_test_fs()` to return absolute paths (to avoid confusion in tests)

## Behavior

### With `pathResolution: config` (default)

```kdl
defaults {
    pathResolution "config"
}

// Assuming doty.kdl is in ~/dotfiles/configs/

LinkFolder "nvim" {
    target "target/.config/nvim"  // Resolves to ~/dotfiles/configs/target/.config/nvim
}

LinkFolder "zsh" {
    target "~/.config/zsh"  // Resolves to ~/.config/zsh (~ expansion)
}

LinkFolder "scripts" {
    target "/opt/scripts"  // Resolves to /opt/scripts (absolute path)
}
```

### With `pathResolution: cwd`

```kdl
defaults {
    pathResolution "cwd"
}

// Assuming you run `doty link` from ~/dotfiles/

LinkFolder "nvim" {
    target "target/.config/nvim"  // Resolves to ~/dotfiles/target/.config/nvim
}

LinkFolder "zsh" {
    target "~/.config/zsh"  // Resolves to ~/.config/zsh (~ expansion)
}

LinkFolder "scripts" {
    target "/opt/scripts"  // Resolves to /opt/scripts (absolute path)
}
```

## Test Results

All 34 tests passing:
- ✅ Config parsing tests (16 tests)
- ✅ State management tests (8 tests)
- ✅ Linker tests (10 tests)

## Key Changes from v1

1. **Added `path_resolution` field to `Linker`**: The linker now knows which strategy to use
2. **Fixed `resolve_target_path()`**: Relative paths are now resolved based on `pathResolution` strategy
3. **Consistent behavior**: Both source and target paths now respect the `pathResolution` strategy

## Architecture Compliance

The implementation now correctly follows the architecture specification:
- ✅ Target paths can be absolute
- ✅ Target paths can be relative (resolved based on `pathResolution`)
- ✅ Target paths can use `~` expansion
- ✅ `pathResolution` strategy affects both source AND target paths consistently

## Next Steps

Phase 1.2 is now complete with the correct implementation. Ready to proceed with Phase 3 (Detection & Adoption) or any other tasks.
